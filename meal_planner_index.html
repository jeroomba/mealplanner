<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Meal Planner — Dark Minimal</title>

  <style>
    /* Minimal dark-mode design */
    :root{
      --bg:#0b0d0f;
      --panel:#0f1214;
      --muted:#9aa4a8;
      --accent:#6ee7b7;
      --glass: rgba(255,255,255,0.03);
      --card: #0d1112;
      --radius:12px;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color-scheme: dark;
    }
    html,body{height:100%;}
    body{
      margin:0;
      background: linear-gradient(180deg,var(--bg), #061011 140%);
      color:#e6eef0;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:18px;
      box-sizing:border-box;
    }

    .app{
      max-width:1200px;
      margin:0 auto;
      display:flex;
      gap:18px;
      align-items:flex-start;
    }

    header{display:flex;align-items:center;gap:16px;margin-bottom:12px}
    h1{font-size:18px;margin:0;font-weight:600}
    .top-controls{margin-left:auto;display:flex;gap:8px;align-items:center}

    .card{
      background: linear-gradient(180deg,var(--panel), rgba(13,17,18,0.8));
      border-radius:var(--radius);
      padding:12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.6);
      border:1px solid rgba(255,255,255,0.02);
    }

    /* Week view grid */
    .week{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:10px;
      width:100%;
    }

    .day{
      min-height:150px;
      display:flex;
      flex-direction:column;
      gap:8px;
      padding:8px;
      border-radius:10px;
      background:var(--glass);
      border:1px solid rgba(255,255,255,0.02);
    }

    .day .title{display:flex;justify-content:space-between;align-items:center;font-size:13px;color:var(--muted)}
    .slot{flex:1;display:flex;flex-direction:column;gap:6px}
    .slot .slot-head{display:flex;justify-content:space-between;align-items:center;font-size:12px;color:var(--muted)}
    .meal-card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.01);font-size:13px}
    .empty{opacity:0.6;font-size:13px}

    .sidebar{
      min-width:320px;max-width:360px;flex:0 0 340px;display:flex;flex-direction:column;gap:12px
    }
    .recipes-list{display:flex;flex-direction:column;gap:8px;max-height:56vh;overflow:auto;padding-right:6px}
    .recipe-item{display:flex;justify-content:space-between;gap:8px;align-items:center;padding:10px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.015), transparent);border:1px solid rgba(255,255,255,0.02)}
    .recipe-meta{font-size:13px;color:var(--muted)}

    .btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:8px;font-size:13px;color:var(--accent);cursor:pointer}
    .btn.ghost{color:var(--muted);border-color:transparent}
    .btn.small{padding:6px 8px;font-size:12px}

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:60}
    .modal{width: min(720px, 96%);background:linear-gradient(180deg,var(--card), #071010);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
    .form-row{display:flex;gap:8px}
    .form-field{display:flex;flex-direction:column;gap:6px;margin-bottom:8px}
    label{font-size:12px;color:var(--muted)}
    input[type="text"], textarea, input[type="url"]{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:8px;color:inherit;font-size:14px}
    textarea{min-height:120px}

    /* Responsive */
    @media (max-width:900px){
      .app{flex-direction:column;padding:12px}
      .sidebar{width:100%;max-width:100%;flex:unset}
      .week{grid-template-columns: repeat(2, 1fr)}
      .day{min-height:140px}
    }
    @media (max-width:480px){
      .week{grid-template-columns: 1fr}
      header{flex-direction:column;align-items:flex-start;gap:10px}
      .top-controls{margin-left:0}
    }

    /* tiny helpers */
    .muted{color:var(--muted)}
    .pill{background:rgba(255,255,255,0.02);padding:6px 8px;border-radius:999px;font-size:12px}
    .search{display:flex;gap:6px;align-items:center}

    .footer-actions{display:flex;gap:8px;justify-content:flex-end}

  </style>
</head>
<body>
  <header class="card" style="display:flex;align-items:center;width:100%;gap:12px">
    <div style="display:flex;gap:12px;align-items:center">
      <h1>Meal Planner</h1>
      <div class="muted">Plan lunches & dinners — week view</div>
    </div>

    <div class="top-controls">
      <div class="pill" id="weekLabel">Week</div>
      <button class="btn small" id="prevWeek">◀</button>
      <button class="btn small" id="nextWeek">▶</button>
      <button class="btn" id="openShopping">Shopping List</button>
      <button class="btn" id="openNewMeal">Add Meal</button>
    </div>
  </header>

  <main class="app">
    <section style="flex:1">
      <div class="card" style="padding:10px;">
        <div class="week" id="weekGrid">
          <!-- days inserted here -->
        </div>
      </div>
    </section>

    <aside class="sidebar">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-weight:600">Recipe Library</div>
          <div class="muted">Saved recipes</div>
        </div>
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <input id="searchRecipes" type="text" placeholder="Search recipes" style="flex:1;background:transparent;border:1px solid rgba(255,255,255,0.03);padding:8px;border-radius:8px;color:inherit;font-size:13px" />
          <button class="btn small" id="openNewRecipe">New</button>
        </div>
        <div class="recipes-list" id="recipesList">
          <!-- recipes -->
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
          <div class="muted">Total: <span id="recipeCount">0</span></div>
          <div style="display:flex;gap:8px">
            <button class="btn ghost small" id="exportData">Export</button>
            <button class="btn ghost small" id="importData">Import</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-weight:600">Week Tools</div>
          <div class="muted">Utilities</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px">
          <button class="btn" id="fillRandom">Fill sample</button>
          <button class="btn ghost" id="clearWeek">Clear week</button>
        </div>
      </div>
    </aside>
  </main>

  <!-- Modal: Add/Edit Meal -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal card" role="dialog" aria-modal="true">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:600" id="modalTitle">Add Meal</div>
        <div><button class="btn" id="closeModal">Close</button></div>
      </div>

      <div>
        <div class="form-field">
          <label>Title</label>
          <input id="mTitle" type="text" placeholder="e.g. Lemon chicken" />
        </div>

        <div class="form-field">
          <label>Ingredients (one per line). If possible prefix with quantity e.g. "2 tomatoes"</label>
          <textarea id="mIngredients" placeholder="2 chicken breasts\n1 lemon\nsalt"></textarea>
        </div>

        <div class="form-field">
          <label>Instructions</label>
          <textarea id="mInstructions" placeholder="Short instructions or paste the recipe steps"></textarea>
        </div>

        <div class="form-row">
          <div style="flex:1" class="form-field">
            <label>Recipe link (optional)</label>
            <input id="mLink" type="url" placeholder="https://" />
          </div>
          <div style="width:160px" class="form-field">
            <label>Save to library</label>
            <select id="saveToLibrary">
              <option value="new">New recipe</option>
              <option value="no">Don't save</option>
            </select>
          </div>
        </div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
          <div class="muted">Editing: <span id="editingInfo">—</span></div>
          <div style="display:flex;gap:8px">
            <button class="btn" id="saveMeal">Save</button>
            <button class="btn ghost" id="deleteMeal">Delete</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Shopping List -->
  <div class="modal-backdrop" id="shopBackdrop">
    <div class="modal card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:600">Shopping List</div>
        <div><button class="btn" id="closeShop">Close</button></div>
      </div>
      <div id="shoppingContent">
        <!-- list generated -->
      </div>
      <div style="display:flex;justify-content:flex-end;margin-top:12px">
        <button class="btn" id="copyList">Copy</button>
        <button class="btn ghost" id="downloadList">Download</button>
      </div>
    </div>
  </div>

  <!-- Hidden file input for import -->
  <input type="file" id="importFile" style="display:none" accept="application/json" />

  <script>
    /*
      Meal Planner - Vanilla JS (localStorage)
      Data model:
        recipes: { id => {id,title,ingredients:[],instructions,link,lastUsed }}
        meals: { date (YYYY-MM-DD) => { lunch: recipeId|null, dinner: recipeId|null, customMeal?:{...} } }
      Limits: week navigation -10 .. +10 weeks
    */

    // Utilities
    function fmtDate(d){ return d.toISOString().slice(0,10); }
    function startOfWeek(date){ // sunday
      const d = new Date(date);
      const day = d.getDay();
      d.setDate(d.getDate() - day);
      d.setHours(0,0,0,0);
      return d;
    }
    function addDays(date, n){ const d = new Date(date); d.setDate(d.getDate()+n); return d; }
    function isoWeekKey(offsetWeeks){
      const now = new Date();
      const base = addDays(startOfWeek(now), offsetWeeks*7);
      return fmtDate(base);
    }

    // storage
    const STORAGE_KEYS = { recipes: 'mp_recipes_v1', meals: 'mp_meals_v1', settings: 'mp_settings_v1' };
    function loadJSON(key, fallback){ try{ const s = localStorage.getItem(key); return s?JSON.parse(s):fallback; }catch(e){return fallback} }
    function saveJSON(key,obj){ localStorage.setItem(key, JSON.stringify(obj)); }

    // App state
    let recipes = loadJSON(STORAGE_KEYS.recipes, {});
    let meals = loadJSON(STORAGE_KEYS.meals, {});
    let settings = loadJSON(STORAGE_KEYS.settings, {weekOffset:0});
    let weekOffset = settings.weekOffset || 0; // 0 = current week
    const WEEK_LIMIT = 10;

    // DOM refs
    const weekGrid = document.getElementById('weekGrid');
    const weekLabel = document.getElementById('weekLabel');
    const prevWeek = document.getElementById('prevWeek');
    const nextWeek = document.getElementById('nextWeek');
    const openNewMeal = document.getElementById('openNewMeal');
    const modalBackdrop = document.getElementById('modalBackdrop');
    const closeModal = document.getElementById('closeModal');
    const mTitle = document.getElementById('mTitle');
    const mIngredients = document.getElementById('mIngredients');
    const mInstructions = document.getElementById('mInstructions');
    const mLink = document.getElementById('mLink');
    const saveMealBtn = document.getElementById('saveMeal');
    const deleteMealBtn = document.getElementById('deleteMeal');
    const editingInfo = document.getElementById('editingInfo');
    const saveToLibrary = document.getElementById('saveToLibrary');
    const recipesList = document.getElementById('recipesList');
    const recipeCount = document.getElementById('recipeCount');
    const searchRecipes = document.getElementById('searchRecipes');
    const openNewRecipe = document.getElementById('openNewRecipe');
    const openShopping = document.getElementById('openShopping');
    const shopBackdrop = document.getElementById('shopBackdrop');
    const shoppingContent = document.getElementById('shoppingContent');
    const closeShop = document.getElementById('closeShop');
    const copyList = document.getElementById('copyList');
    const downloadList = document.getElementById('downloadList');
    const exportData = document.getElementById('exportData');
    const importData = document.getElementById('importData');
    const importFile = document.getElementById('importFile');
    const fillRandom = document.getElementById('fillRandom');
    const clearWeek = document.getElementById('clearWeek');

    // editing context
    let editingContext = null; // {date: 'YYYY-MM-DD', slot: 'lunch'|'dinner', recipeId|null}

    function persistAll(){ saveJSON(STORAGE_KEYS.recipes,recipes); saveJSON(STORAGE_KEYS.meals,meals); saveJSON(STORAGE_KEYS.settings,{weekOffset}); }

    // ID generator
    function uid(prefix='r'){ return prefix + '_' + Math.random().toString(36).slice(2,9); }

    // ---- Recipes management ----
    function addRecipe(data){ const id = data.id || uid('rec'); data.id = id; data.lastUsed = data.lastUsed||Date.now(); recipes[id]=data; persistAll(); return id; }
    function updateRecipe(id, data){ if(!recipes[id]) return; recipes[id] = {...recipes[id],...data, lastUsed:Date.now()}; persistAll(); }
    function deleteRecipe(id){ delete recipes[id]; // also remove references in meals
      Object.keys(meals).forEach(d=>{ ['lunch','dinner'].forEach(s=>{ if(meals[d] && meals[d][s]===id) meals[d][s]=null; }); }); persistAll(); render(); }

    // ---- Meals management ----
    function setMeal(date, slot, recipeId){ if(!meals[date]) meals[date] = {lunch:null,dinner:null}; meals[date][slot]=recipeId; persistAll(); render(); }
    function clearMeal(date, slot){ if(meals[date]){ meals[date][slot]=null; persistAll(); render(); } }
    function clearWeekData(startDateISO){ const start = new Date(startDateISO); for(let i=0;i<7;i++){ const d = fmtDate(addDays(start,i)); delete meals[d]; } persistAll(); render(); }

    // Render week
    function render(){ renderWeek(); renderRecipesList(); }

    function formatWeekLabel(startDate){ const a = new Date(startDate); const b = addDays(a,6); const opts = {month:'short', day:'numeric'}; return a.toLocaleDateString(undefined,opts) + ' — ' + b.toLocaleDateString(undefined,opts); }

    function renderWeek(){ const startISO = isoWeekKey(weekOffset); const start = new Date(startISO);
      weekLabel.textContent = formatWeekLabel(startISO);
      weekGrid.innerHTML='';
      for(let i=0;i<7;i++){
        const dayDate = addDays(start,i);
        const iso = fmtDate(dayDate);
        const dow = dayDate.toLocaleDateString(undefined,{weekday:'short'});
        const dayEl = document.createElement('div'); dayEl.className='day card';
        dayEl.innerHTML = `<div class="title"><div>${dow}</div><div class="muted">${iso}</div></div>`;

        ['lunch','dinner'].forEach(slot=>{
          const slotEl = document.createElement('div'); slotEl.className='slot';
          const head = document.createElement('div'); head.className='slot-head'; head.innerHTML = `<div>${slot}</div><div><button class="btn small" data-action="add" data-date="${iso}" data-slot="${slot}">Add</button></div>`;
          slotEl.appendChild(head);

          const content = document.createElement('div');
          const recId = meals[iso] && meals[iso][slot] ? meals[iso][slot] : null;
          if(recId && recipes[recId]){
            const r = recipes[recId];
            const mealCard = document.createElement('div'); mealCard.className='meal-card';
            mealCard.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:600">${escapeHtml(r.title)}</div><div style="font-size:12px;color:var(--muted)"> <button class=\"btn small\" data-action=\"edit\" data-date=\"${iso}\" data-slot=\"${slot}\">Edit</button> <button class=\"btn small\" data-action=\"remove\" data-date=\"${iso}\" data-slot=\"${slot}\">Remove</button></div></div><div class="muted" style="margin-top:6px;font-size:13px">${escapeHtml((r.ingredients||[]).slice(0,3).join(', '))}${(r.ingredients||[]).length>3? '...':''}</div>`;
            content.appendChild(mealCard);
          } else {
            const empty = document.createElement('div'); empty.className='meal-card empty'; empty.textContent='No meal planned';
            content.appendChild(empty);
          }
          slotEl.appendChild(content);
          dayEl.appendChild(slotEl);
        });

        weekGrid.appendChild(dayEl);
      }

      // attach handlers for add/edit/remove
      weekGrid.querySelectorAll('button').forEach(btn=>{
        btn.addEventListener('click', (ev)=>{
          const action = btn.dataset.action;
          const date = btn.dataset.date;
          const slot = btn.dataset.slot;
          if(action==='add'){ openMealModal({date,slot,recipeId:null}); }
          if(action==='edit'){ openMealModal({date,slot,recipeId:meals[date][slot]}); }
          if(action==='remove'){ if(confirm('Remove meal?')){ setMeal(date,slot,null); } }
        });
      });
    }

    // escape html
    function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>\"]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"})[c]); }

    // ---- Modal logic ----
    function openMealModal(ctx){ editingContext = ctx; modalBackdrop.style.display='flex'; document.body.style.overflow='hidden';
      document.getElementById('modalTitle').textContent = ctx.recipeId ? 'Edit Meal' : 'Add Meal';
      editingInfo.textContent = `${ctx.date} · ${ctx.slot}`;
      deleteMealBtn.style.display = ctx.recipeId ? 'inline-block' : 'none';
      if(ctx.recipeId && recipes[ctx.recipeId]){
        const r = recipes[ctx.recipeId]; mTitle.value = r.title || ''; mIngredients.value = (r.ingredients||[]).join('\n'); mInstructions.value = r.instructions||''; mLink.value = r.link||''; saveToLibrary.value='no';
      } else { mTitle.value=''; mIngredients.value=''; mInstructions.value=''; mLink.value=''; saveToLibrary.value='new'; }
    }
    function closeMealModal(){ modalBackdrop.style.display='none'; document.body.style.overflow='auto'; editingContext=null; }

    closeModal.addEventListener('click', closeMealModal);
    modalBackdrop.addEventListener('click', (e)=>{ if(e.target===modalBackdrop) closeMealModal(); });

    saveMealBtn.addEventListener('click', ()=>{
      if(!editingContext) return;
      const title = mTitle.value.trim() || 'Untitled';
      const ingredients = mIngredients.value.split('\n').map(s=>s.trim()).filter(Boolean);
      const instructions = mInstructions.value.trim();
      const link = mLink.value.trim();
      if(saveToLibrary.value === 'new'){
        const rid = addRecipe({title,ingredients,instructions,link,lastUsed:Date.now()});
        setMeal(editingContext.date, editingContext.slot, rid);
      } else {
        // just create an ephemeral recipe stored inside meals (store full object inline) — but we'll instead create a recipe only if user chose
        const rid = addRecipe({title,ingredients,instructions,link,lastUsed:Date.now()});
        setMeal(editingContext.date, editingContext.slot, rid);
      }
      closeMealModal();
    });

    deleteMealBtn.addEventListener('click', ()=>{
      if(!editingContext) return;
      if(confirm('Delete this recipe from library? This will also remove it from any planned slots.')){
        if(editingContext.recipeId){ deleteRecipe(editingContext.recipeId); }
        closeMealModal();
      }
    });

    // ---- Recipes sidebar ----
    function renderRecipesList(){ recipesList.innerHTML='';
      const q = searchRecipes.value.trim().toLowerCase();
      const arr = Object.values(recipes).sort((a,b)=> (b.lastUsed||0)-(a.lastUsed||0));
      const filtered = q? arr.filter(r=> (r.title||'').toLowerCase().includes(q) || (r.ingredients||[]).join(' ').toLowerCase().includes(q)) : arr;
      filtered.forEach(r=>{
        const item = document.createElement('div'); item.className='recipe-item';
        item.innerHTML = `<div style="flex:1"><div style="font-weight:600">${escapeHtml(r.title)}</div><div class="recipe-meta">${escapeHtml((r.ingredients||[]).slice(0,3).join(', '))}${(r.ingredients||[]).length>3?'...':''}</div></div><div style="display:flex;flex-direction:column;gap:6px"><button class="btn small" data-action="use" data-id="${r.id}">Use</button><button class="btn small" data-action="view" data-id="${r.id}">View</button></div>`;
        recipesList.appendChild(item);
      });
      recipeCount.textContent = Object.keys(recipes).length;

      // attach handlers
      recipesList.querySelectorAll('button').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = btn.dataset.id; const action = btn.dataset.action;
          if(action==='use'){
            // place into currently selected week first empty slot (or open modal to choose date) — we open a quick picker
            quickPlaceRecipe(id);
          }
          if(action==='view'){
            const r = recipes[id]; if(!r) return; mTitle.value=r.title; mIngredients.value=(r.ingredients||[]).join('\n'); mInstructions.value=r.instructions||''; mLink.value=r.link||''; saveToLibrary.value='no'; openMealModal({date:isoWeekKey(weekOffset),slot:'lunch',recipeId:id});
          }
        });
      });
    }

    function quickPlaceRecipe(id){ // open small dialog to pick date/slot
      const startISO = isoWeekKey(weekOffset); const start = new Date(startISO);
      const choice = prompt('Choose day of week to place recipe (Sun=0 ... Sat=6). Default 0');
      let dIndex = parseInt(choice);
      if(isNaN(dIndex) || dIndex<0 || dIndex>6) dIndex=0;
      const slot = prompt('Slot: lunch or dinner','lunch') || 'lunch';
      const date = fmtDate(addDays(start,dIndex)); setMeal(date, slot==='dinner'?'dinner':'lunch', id);
    }

    searchRecipes.addEventListener('input', renderRecipesList);
    openNewRecipe.addEventListener('click', ()=>{ // open modal blank with saveToLibrary new and no editingContext
      editingContext = {date: isoWeekKey(weekOffset), slot:'lunch', recipeId:null}; mTitle.value=''; mIngredients.value=''; mInstructions.value=''; mLink.value=''; saveToLibrary.value='new'; document.getElementById('modalTitle').textContent='New Recipe'; editingInfo.textContent='Library'; modalBackdrop.style.display='flex'; document.body.style.overflow='hidden'; deleteMealBtn.style.display='none';
    });

    // ---- Shopping list ----
    function openShoppingModal(){ shopBackdrop.style.display='flex'; document.body.style.overflow='hidden'; renderShopping(); }
    function closeShoppingModal(){ shopBackdrop.style.display='none'; document.body.style.overflow='auto'; }
    openShopping.addEventListener('click', openShoppingModal);
    closeShop.addEventListener('click', closeShoppingModal);
    shopBackdrop.addEventListener('click',(e)=>{ if(e.target===shopBackdrop) closeShoppingModal(); });

    function gatherWeekIngredients(startISO){ const start = new Date(startISO); const map = {}; // key -> {qty,unit,name,raws:[]}
      for(let i=0;i<7;i++){
        const iso = fmtDate(addDays(start,i)); ['lunch','dinner'].forEach(slot=>{
          const rid = meals[iso] && meals[iso][slot]; if(!rid) return; const r = recipes[rid]; if(!r) return;
          r.ingredients.forEach(line=>{
            const parsed = parseIngredient(line);
            const key = (parsed.name + '|' + (parsed.unit||'')).toLowerCase();
            if(!map[key]) map[key] = {name:parsed.name,unit:parsed.unit,qty:0,raw:[]};
            if(parsed.qty) map[key].qty += parsed.qty; else map[key].raw.push(parsed.raw);
          });
        });
      }
      return map;
    }

    function renderShopping(){ const startISO = isoWeekKey(weekOffset); const map = gatherWeekIngredients(startISO);
      const keys = Object.keys(map).sort((a,b)=> map[a].name.localeCompare(map[b].name));
      if(keys.length===0){ shoppingContent.innerHTML = '<div class="muted">No ingredients for this week</div>'; return; }
      const ul = document.createElement('div'); ul.style.display='flex'; ul.style.flexDirection='column'; ul.style.gap='8px';
      keys.forEach(k=>{
        const it = map[k]; const qtyText = it.qty ? (it.unit? (it.qty + ' ' + it.unit) : (it.qty)) : (it.raw.join(', '));
        const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='8px'; row.style.borderRadius='8px'; row.style.background='rgba(255,255,255,0.02)';
        row.innerHTML = `<div><div style="font-weight:600">${escapeHtml(it.name)}</div><div class="muted" style="font-size:13px">${escapeHtml(qtyText)}</div></div><div><button class="btn small" data-name="${escapeHtml(it.name)}">Got</button></div>`;
        ul.appendChild(row);
      });
      shoppingContent.innerHTML=''; shoppingContent.appendChild(ul);
    }

    copyList.addEventListener('click', ()=>{
      const startISO = isoWeekKey(weekOffset); const map = gatherWeekIngredients(startISO); const lines = Object.values(map).map(it=> (it.qty? (it.qty + (it.unit? ' ' + it.unit: '')) : it.raw.join(', ')) + ' — ' + it.name );
      navigator.clipboard.writeText(lines.join('\n')).then(()=> alert('Copied to clipboard'));
    });
    downloadList.addEventListener('click', ()=>{
      const startISO = isoWeekKey(weekOffset); const map = gatherWeekIngredients(startISO); const lines = Object.values(map).map(it=> (it.qty? (it.qty + (it.unit? ' ' + it.unit: '')) : it.raw.join(', ')) + ' — ' + it.name );
      const blob = new Blob([lines.join('\n')],{type:'text/plain'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='shopping.txt'; a.click(); URL.revokeObjectURL(url);
    });

    // ingredient parser (best-effort): looks for leading number (int/float) and optional unit
    function parseIngredient(line){ const raw = line.trim(); const m = raw.match(/^([0-9]+\/?[0-9]*\.?[0-9]*)\s*(\w+)?\s*(.*)$/); if(m){ // handles things like '2', '1/2', '1.5'
      let qty = parseFractionOrNumber(m[1]); const unit = m[2] || ''; const name = (m[3]||'').trim() || unit; return {qty,unit,name,raw}; }
      return {qty:0,unit:'',name:raw,raw};
    }
    function parseFractionOrNumber(s){ if(s.includes('/')){ const parts = s.split('/'); const a=parseFloat(parts[0])||0; const b=parseFloat(parts[1])||1; return a/b; } return parseFloat(s) || 0; }

    // ---- Export / Import ----
    exportData.addEventListener('click', ()=>{
      const dump = {recipes,meals,settings}; const blob = new Blob([JSON.stringify(dump, null, 2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='mealplanner-export.json'; a.click(); URL.revokeObjectURL(url);
    });
    importData.addEventListener('click', ()=> importFile.click());
    importFile.addEventListener('change', (e)=>{
      const f = e.target.files[0]; if(!f) return; const reader = new FileReader(); reader.onload = ()=>{ try{ const d = JSON.parse(reader.result); if(d.recipes) recipes = d.recipes; if(d.meals) meals = d.meals; if(d.settings) settings = d.settings; persistAll(); render(); alert('Import complete'); }catch(err){alert('Invalid file');} }; reader.readAsText(f);
    });

    // ---- helpers: sample data, clear week ----
    fillRandom.addEventListener('click', ()=>{
      if(!confirm('Fill this week with some sample meals?')) return;
      // simple sample recipes
      const r1 = addRecipe({title:'Spaghetti Bolognese', ingredients:['200 spaghetti','300g minced beef','1 can tomato'], instructions:'Cook pasta. Saute beef. Mix.'});
      const r2 = addRecipe({title:'Grilled Salmon', ingredients:['2 salmon fillets','1 lemon','salt'], instructions:'Grill fish, season.'});
      const r3 = addRecipe({title:'Chickpea Salad', ingredients:['1 can chickpeas','2 tomatoes','1 cucumber','olive oil'], instructions:'Mix ingredients.'});
      const startISO = isoWeekKey(weekOffset); const start = new Date(startISO);
      setMeal(fmtDate(addDays(start,0)),'dinner', r1);
      setMeal(fmtDate(addDays(start,1)),'lunch', r3);
      setMeal(fmtDate(addDays(start,2)),'dinner', r2);
      setMeal(fmtDate(addDays(start,4)),'lunch', r1);
    });

    clearWeek.addEventListener('click', ()=>{
      if(!confirm('Clear all meals in this week?')) return; clearWeekData(isoWeekKey(weekOffset));
    });

    // ---- week navigation handlers ----
    prevWeek.addEventListener('click', ()=>{ if(weekOffset - 1 < -WEEK_LIMIT) return alert('Limit reached'); weekOffset--; persistAll(); render(); });
    nextWeek.addEventListener('click', ()=>{ if(weekOffset + 1 > WEEK_LIMIT) return alert('Limit reached'); weekOffset++; persistAll(); render(); });

    // ---- quick load initial render ----
    render();

    // small keyboard shortcuts
    document.addEventListener('keydown',(e)=>{
      if(e.key==='Escape'){ if(modalBackdrop.style.display==='flex') closeMealModal(); if(shopBackdrop.style.display==='flex') closeShoppingModal(); }
    });

    // small helper: when opening modal by clicking on recipe view, we used openMealModal with recipeId. ensure save button will update recipe too

  </script>
</body>
</html>
